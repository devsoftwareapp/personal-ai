<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Personal AI</title>
<style>
body{
  background:#0f0f0f;
  color:#fff;
  font-family:system-ui;
  padding:20px;
}
#chat{
  white-space:pre-wrap;
  margin-top:20px;
}
input,button{
  padding:10px;
  font-size:16px;
}
</style>
</head>
<body>

<h2 id="status">Loading...</h2>

<input id="input" placeholder="Message">
<button onclick="send()">Send</button>

<div id="chat"></div>

<script type="module">

import { pipeline, env } from
"https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2";

// CRITICAL ANDROID FIX
env.allowLocalModels = false;
env.useBrowserCache = true;
env.backends.onnx.wasm.numThreads = 1;
env.backends.onnx.wasm.simd = false;

let pipe;

let history =
"You are a helpful assistant.";

// LOAD MODEL
async function init(){

  try{

    document.getElementById("status").innerText =
    "Downloading small model...";

    pipe = await pipeline(
      "text-generation",
      "Xenova/distilgpt2",
      {
        quantized:true
      }
    );

    document.getElementById("status").innerText =
    "AI Ready";

  }catch(e){

    document.getElementById("status").innerText =
    "ERROR: "+e.message;

    console.log(e);

  }

}

// SEND MESSAGE
window.send = async function(){

  if(!pipe){
    alert("Model still loading");
    return;
  }

  const input =
  document.getElementById("input");

  const chat =
  document.getElementById("chat");

  const msg =
  input.value.trim();

  if(!msg)return;

  chat.innerHTML +=
  "\nYOU: "+msg+
  "\nAI: thinking...";

  input.value="";

  try{

    const prompt =
    history+
    "\nUser:"+msg+
    "\nAssistant:";

    const result =
    await pipe(prompt,{
      max_new_tokens:20,
      do_sample:false
    });

    const text =
    result[0].generated_text;

    let reply =
    text.slice(prompt.length).trim();

    if(!reply) reply="Ok.";

    chat.innerHTML =
    chat.innerHTML.replace(
      "AI: thinking...",
      "AI: "+reply
    );

    history+=
    "\nUser:"+msg+
    "\nAssistant:"+reply;

  }catch(e){

    chat.innerHTML =
    chat.innerHTML.replace(
      "AI: thinking...",
      "ERROR: "+e.message
    );

  }

}

init();

</script>

</body>
</html>
