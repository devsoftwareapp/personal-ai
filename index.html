<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Personal AI</title>

<style>
body{
  background:#0f0f0f;
  color:#ffffff;
  font-family:system-ui;
  padding:20px;
}

#status{
  margin-bottom:10px;
  font-weight:bold;
}

#chat{
  white-space:pre-wrap;
  margin-top:20px;
}

input{
  padding:10px;
  font-size:16px;
  width:70%;
}

button{
  padding:10px;
  font-size:16px;
}
</style>

</head>
<body>

<h2 id="status">Starting...</h2>

<input id="input" placeholder="Message">
<button onclick="send()">Send</button>

<div id="chat"></div>

<script type="module">

import { pipeline, env }
from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2";

// ANDROID CRITICAL FIXES
env.allowLocalModels = false;
env.useBrowserCache = true;
env.backends.onnx.wasm.numThreads = 1;
env.backends.onnx.wasm.simd = false;

let pipe;

// SYSTEM PROMPT
let history =
"You are a helpful assistant.";


// LOAD MODEL WITH % PROGRESS
async function init(){

  try{

    const status =
    document.getElementById("status");

    status.innerText =
    "Preparing download...";

    pipe = await pipeline(
      "text-generation",
      "Xenova/distilgpt2",
      {

        quantized:true,

        progress_callback:(p)=>{

          if(p.status==="download"){

            const percent =
            Math.round(p.progress||0);

            status.innerText =
            "Downloading model: "+
            percent+"%";

          }

          if(p.status==="ready"){

            status.innerText =
            "AI Ready";

          }

        }

      }
    );

    status.innerText =
    "AI Ready";

  }
  catch(e){

    document.getElementById("status").innerText =
    "Error: "+e.message;

    console.log(e);

  }

}



// SEND MESSAGE
window.send =
async function(){

  if(!pipe){

    alert("Model loading...");
    return;

  }

  const input =
  document.getElementById("input");

  const chat =
  document.getElementById("chat");

  const msg =
  input.value.trim();

  if(!msg)return;

  chat.innerHTML +=
  "\nYOU: "+msg+
  "\nAI: thinking...";

  input.value="";


  try{

    const prompt =
    history+
    "\nUser:"+msg+
    "\nAssistant:";


    const result =
    await pipe(
      prompt,
      {
        max_new_tokens:20,
        do_sample:false
      }
    );


    const text =
    result[0].generated_text;


    let reply =
    text.slice(prompt.length).trim();


    if(!reply)
    reply="Ok.";


    chat.innerHTML =
    chat.innerHTML.replace(
      "AI: thinking...",
      "AI: "+reply
    );


    history+=
    "\nUser:"+msg+
    "\nAssistant:"+reply;


  }
  catch(e){

    chat.innerHTML =
    chat.innerHTML.replace(
      "AI: thinking...",
      "Error: "+e.message
    );

  }

}


// START
init();

</script>

</body>
</html>
