<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Personal AI</title>
<style>
body {
  font-family: Arial;
  padding: 20px;
  background: #111;
  color: white;
}
input, button {
  padding: 10px;
  font-size: 16px;
}
#chat {
  margin-top: 20px;
  white-space: pre-wrap;
}
</style>
</head>
<body>

<h2 id="status">AI y√ºkleniyor...</h2>

<input id="input" placeholder="Mesaj yaz" style="width:70%">
<button onclick="send()">G√∂nder</button>

<div id="chat"></div>

<script type="module">

import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@xenova/transformers";

// CRITICAL FIXES
env.allowLocalModels = false;
env.useBrowserCache = true;

let generator;
let history = "";

// LOAD MODEL
async function load() {

  try {

    document.getElementById("status").innerText = "Model indiriliyor...";

    generator = await pipeline(
      "text-generation",
      "Xenova/distilgpt2",
      {
        quantized: true,
        progress_callback: (p) => {
          document.getElementById("status").innerText =
            "ƒ∞ndiriliyor: " + Math.round(p.progress || 0) + "%";
        }
      }
    );

    document.getElementById("status").innerText = "AI hazƒ±r";

  } catch (e) {

    document.getElementById("status").innerText =
      "HATA: " + e.message;

    console.error(e);
  }
}

// SEND MESSAGE
window.send = async function() {

  if (!generator) {
    alert("AI hen√ºz hazƒ±r deƒüil");
    return;
  }

  const input = document.getElementById("input");
  const chat = document.getElementById("chat");

  const userText = input.value.trim();

  if (!userText) return;

  chat.innerHTML += "\nüßë Sen: " + userText;
  chat.innerHTML += "\nü§ñ AI d√º≈ü√ºn√ºyor...";

  input.value = "";

  try {

    const prompt =
      history +
      "\nUser: " + userText +
      "\nAI:";

    const result = await generator(prompt, {
      max_new_tokens: 30,
      do_sample: false
    });

    let output = result[0].generated_text;

    let answer = output.split("AI:").pop().trim();

    if (!answer) answer = "...";

    chat.innerHTML =
      chat.innerHTML.replace("ü§ñ AI d√º≈ü√ºn√ºyor...", "ü§ñ AI: " + answer);

    history += "\nUser: " + userText + "\nAI: " + answer;

  } catch (e) {

    chat.innerHTML =
      chat.innerHTML.replace(
        "ü§ñ AI d√º≈ü√ºn√ºyor...",
        "‚ùå HATA: " + e.message
      );

    console.error(e);
  }
}

load();

</script>

</body>
</html>
